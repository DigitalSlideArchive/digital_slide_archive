Bootstrap: docker
From: dsarchive/dsa_common

%setup

%files

%environment
    export NVM_DIR=/opt/nvm
    . $NVM_DIR/nvm.sh

%post
    set -x
    # install nvm / node properly
    export NVM_DIR=/opt/nvm

    git clone https://github.com/nvm-sh/nvm.git $NVM_DIR
    . $NVM_DIR/nvm.sh
    
    nvm install 14 && \
    nvm alias default 14 && \
    nvm use default

    # install pyaml in virtual environment
    . /opt/venv/bin/activate
    /opt/venv/bin/pip install pyaml

    mv /opt /root_opt

    # install apptainer
    apt install -y software-properties-common
    add-apt-repository -y ppa:apptainer/ppa
    apt update
    apt install -y apptainer

%runscript
    set -x

    export NVM_DIR=/opt/nvm
    . $NVM_DIR/nvm.sh
    . /opt/venv/bin/activate

    bash -c "$@"

%startscript
    # assuming that the user mounts a local directory to /opt/
    # this is necessary for getting the correct singularity permissions
    echo " - Copying docker image's opt (/root_opt) to user mounted /opt"
    echo " - Make sure you're mounting a local directory to /opt"
    cp -r /root_opt/* /opt
